<script>
    // ==== MOBILE NAVIGATION ====
    const navToggle = document.getElementById('navToggle');
    const navLinks = document.getElementById('navLinks');
    
    navToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      navLinks.classList.toggle('open');
      const icon = navToggle.querySelector('i');
      icon.className = navLinks.classList.contains('open') ? 'fas fa-times' : 'fas fa-bars';
    });

    function closeMobileMenu() {
      navLinks.classList.remove('open');
      navToggle.querySelector('i').className = 'fas fa-bars';
    }

    document.addEventListener('click', (e) => {
      if (!navToggle.contains(e.target) && !navLinks.contains(e.target)) {
        closeMobileMenu();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && navLinks.classList.contains('open')) {
        closeMobileMenu();
      }
    });

    // ==== DARK MODE ====
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const icon = themeToggle.querySelector('i');
      if (document.body.classList.contains('dark-mode')) {
        icon.className = 'fas fa-sun';
        localStorage.setItem('theme', 'dark');
      } else {
        icon.className = 'fas fa-moon';
        localStorage.setItem('theme', 'light');
      }
    });

    // Load saved theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.body.classList.add('dark-mode');
      themeToggle.querySelector('i').className = 'fas fa-sun';
    }

    // ==== DATABASE CONFIGURATION ====
    const DATABASE_CONFIG = {
      // Option 1: Use localStorage as fallback
      useLocalStorage: true,
      
      // Option 2: Google Sheets API (configure with your URL)
      googleSheets: {
        enabled: false, // Set to true when ready
        scriptURL: 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec'
      },
      
      // Option 3: JSONbin.io (free online JSON storage)
      jsonbin: {
        enabled: false,
        binId: '',
        apiKey: ''
      }
    };

    // ==== QUIZ LOGIC ====
    const questionPool = [
      {
        question: "You receive an email from 'security@bank-official.com' asking to verify your account immediately due to 'suspicious activity'. The sender address looks official. What should you do?",
        answer: false,
        explanation: "üö® Phishing emails often use urgent language and spoofed sender addresses. Never click links in unsolicited emails."
      },
      // ... (keep all your existing 25 questions)
      // ... (I'm truncating for brevity, but keep all your questions)
    ];

    let currentQuestions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    const questionsPerQuiz = 5;
    
    // Initialize quiz with random questions
    function initializeQuiz() {
      currentQuestions = getRandomQuestions(questionsPerQuiz);
      currentQuestionIndex = 0;
      score = 0;
      
      // Reset UI
      document.getElementById('final-score').style.display = 'none';
      document.getElementById('save-btn').style.display = 'none';
      document.querySelector('.question-box').style.display = 'block';
      
      // Update displays
      updateQuestionDisplay();
      updateCounters();
      updateProgressBar();
      
      // Re-enable buttons
      document.querySelectorAll('.buttons button').forEach(btn => {
        btn.disabled = false;
      });
      
      // Clear feedback
      document.getElementById('feedback').textContent = '';
      document.getElementById('feedback').style.background = 'transparent';
    }

    function getRandomQuestions(count) {
      const shuffled = [...questionPool].sort(() => 0.5 - Math.random());
      return shuffled.slice(0, count);
    }

    function updateQuestionDisplay() {
      if (currentQuestionIndex < currentQuestions.length) {
        const question = currentQuestions[currentQuestionIndex];
        document.getElementById('question').textContent = question.question;
      }
    }

    function updateCounters() {
      document.getElementById('question-counter').textContent = 
        `${currentQuestionIndex + 1}/${currentQuestions.length}`;
      document.getElementById('score-counter').textContent = score;
    }

    function updateProgressBar() {
      const progressPercentage = (currentQuestionIndex / currentQuestions.length) * 100;
      document.getElementById('progress-fill').style.width = `${progressPercentage}%`;
    }

    function checkAnswer(userAnswer) {
      const correctAnswer = currentQuestions[currentQuestionIndex].answer;
      const feedbackElement = document.getElementById('feedback');
      
      if (userAnswer === correctAnswer) {
        score++;
        feedbackElement.innerHTML = `<i class="fas fa-check-circle"></i> ‚úÖ Correct! ${currentQuestions[currentQuestionIndex].explanation}`;
        feedbackElement.style.background = 'linear-gradient(135deg, rgba(209, 250, 229, 0.9), rgba(167, 243, 208, 0.95))';
        feedbackElement.style.color = '#065f46';
        feedbackElement.style.border = '2px solid #10b981';
      } else {
        feedbackElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> üö® Incorrect! ${currentQuestions[currentQuestionIndex].explanation}`;
        feedbackElement.style.background = 'linear-gradient(135deg, rgba(254, 226, 226, 0.9), rgba(254, 202, 202, 0.95))';
        feedbackElement.style.color = '#991b1b';
        feedbackElement.style.border = '2px solid #ef4444';
      }
      
      // Disable buttons after answering
      document.querySelectorAll('.buttons button').forEach(btn => {
        btn.disabled = true;
      });
      
      updateCounters();
      
      // Auto-advance after 1.5 seconds
      setTimeout(() => {
        currentQuestionIndex++;
        if (currentQuestionIndex < currentQuestions.length) {
          updateQuestionDisplay();
          updateCounters();
          updateProgressBar();
          document.querySelectorAll('.buttons button').forEach(btn => {
            btn.disabled = false;
          });
          feedbackElement.textContent = '';
          feedbackElement.style.background = 'transparent';
        } else {
          showFinalScore();
        }
      }, 1500);
    }

    function showFinalScore() {
      const scoreElement = document.getElementById('final-score');
      const percentage = Math.round((score / currentQuestions.length) * 100);
      
      let message = '';
      let emoji = '';
      let color = '';
      
      if (score === currentQuestions.length) {
        message = 'üèÜ PERFECT SCORE! You are a cybersecurity expert!';
        emoji = 'üéØ';
        color = 'linear-gradient(135deg, #10b981, #059669)';
      } else if (percentage >= 80) {
        message = '‚úÖ Excellent! Strong cybersecurity awareness.';
        emoji = 'üåü';
        color = 'linear-gradient(135deg, #3b82f6, #2563eb)';
      } else if (percentage >= 60) {
        message = '‚ö†Ô∏è Good effort! Review the security protocols to improve.';
        emoji = 'üìö';
        color = 'linear-gradient(135deg, #f59e0b, #d97706)';
      } else {
        message = 'üö® Needs improvement. Study the security alerts carefully.';
        emoji = 'üéØ';
        color = 'linear-gradient(135deg, #ef4444, #dc2626)';
      }
      
      scoreElement.innerHTML = `
        <h3 style="margin-bottom: 1rem;">Quiz Complete! ${emoji}</h3>
        <div style="font-size: 2.5rem; font-weight: 700; margin: 1rem 0; color: white;">${score}/${currentQuestions.length}</div>
        <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; color: white;">${percentage}% Accuracy</div>
        <p style="margin-bottom: 1.5rem;">${message}</p>
        <p><small>Questions were randomly selected from our pool of 25 cybersecurity scenarios.</small></p>
      `;
      
      scoreElement.style.background = color;
      scoreElement.style.color = 'white';
      scoreElement.style.display = 'block';
      
      document.querySelector('.question-box').style.display = 'none';
      document.getElementById('save-btn').style.display = 'flex';
      document.getElementById('progress-fill').style.width = '100%';
      
      // Add confetti effect for perfect score
      if (score === currentQuestions.length) {
        createConfetti();
      }
    }

    // ==== DATABASE FUNCTIONS ====
    
    // Load leaderboard from database
    async function loadLeaderboard() {
      try {
        // Try to load from localStorage first
        const localData = localStorage.getItem('cyber-shield-leaderboard');
        
        if (localData) {
          const data = JSON.parse(localData);
          return data;
        }
        
        // If Google Sheets is enabled, try to fetch from there
        if (DATABASE_CONFIG.googleSheets.enabled) {
          const response = await fetch(DATABASE_CONFIG.googleSheets.scriptURL + '?action=get');
          const data = await response.json();
          return data;
        }
        
        return [];
      } catch (error) {
        console.error('Error loading leaderboard:', error);
        return [];
      }
    }
    
    // Save score to database
    async function saveScore() {
      const playerName = prompt('Enter your name for the leaderboard (max 15 chars):', 'Cyber Defender');
      if (!playerName || playerName.trim() === '') return;
      
      const name = playerName.trim().substring(0, 15);
      const percentage = Math.round((score / currentQuestions.length) * 100);
      
      const scoreData = {
        id: Date.now(),
        name: name,
        score: score,
        total: currentQuestions.length,
        percentage: percentage,
        date: new Date().toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }),
        timestamp: Date.now()
      };
      
      try {
        // Save to localStorage
        let leaderboard = JSON.parse(localStorage.getItem('cyber-shield-leaderboard')) || [];
        leaderboard.push(scoreData);
        
        // Sort by score (descending) and then by date (newest first)
        leaderboard.sort((a, b) => {
          if (b.score !== a.score) return b.score - a.score;
          return b.timestamp - a.timestamp;
        });
        
        // Keep only top 15 scores
        leaderboard = leaderboard.slice(0, 15);
        
        // Save to localStorage
        localStorage.setItem('cyber-shield-leaderboard', JSON.stringify(leaderboard));
        
        // If Google Sheets is enabled, also save there
        if (DATABASE_CONFIG.googleSheets.enabled) {
          await saveToGoogleSheets(scoreData);
        }
        
        // Update leaderboard display
        updateLeaderboard(leaderboard);
        
        // Show success message
        const rank = leaderboard.findIndex(s => s.id === scoreData.id) + 1;
        alert(`üéâ Score saved! You're rank #${rank} on the leaderboard!`);
        
      } catch (error) {
        console.error('Error saving score:', error);
        alert('‚ö†Ô∏è Could not save score. Please try again.');
      }
    }
    
    // Save to Google Sheets
    async function saveToGoogleSheets(data) {
      if (!DATABASE_CONFIG.googleSheets.enabled) return;
      
      try {
        const response = await fetch(DATABASE_CONFIG.googleSheets.scriptURL, {
          method: 'POST',
          mode: 'no-cors', // Important for Google Apps Script
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'save',
            data: data
          })
        });
        
        // Note: With 'no-cors' we can't read the response, but the data will be sent
        console.log('Score saved to Google Sheets');
      } catch (error) {
        console.error('Google Sheets error:', error);
      }
    }
    
    // Update leaderboard display
    function updateLeaderboard(data = null) {
      const leaderboardBody = document.getElementById('leaderboard-body');
      const emptyLeaderboard = document.getElementById('empty-leaderboard');
      
      if (!data) {
        data = JSON.parse(localStorage.getItem('cyber-shield-leaderboard')) || [];
      }
      
      if (data.length === 0) {
        leaderboardBody.innerHTML = '';
        emptyLeaderboard.style.display = 'block';
        return;
      }
      
      emptyLeaderboard.style.display = 'none';
      leaderboardBody.innerHTML = '';
      
      data.forEach((entry, index) => {
        const row = document.createElement('tr');
        const rank = index + 1;
        
        // Rank styling
        if (rank === 1) row.className = 'rank-1';
        else if (rank === 2) row.className = 'rank-2';
        else if (rank === 3) row.className = 'rank-3';
        else row.className = 'rank-other';
        
        // Rank icon
        let rankIcon = '';
        if (rank === 1) rankIcon = 'üëë';
        else if (rank === 2) rankIcon = 'ü•à';
        else if (rank === 3) rankIcon = 'ü•â';
        else rankIcon = 'üèÖ';
        
        row.innerHTML = `
          <td>
            <div class="rank-badge">${rankIcon} ${rank}</div>
          </td>
          <td style="font-weight: 600; color: var(--text-dark);">${entry.name}</td>
          <td class="score-cell">${entry.score}/${entry.total}</td>
          <td class="date-cell">${entry.date}</td>
          <td>
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                <div style="width: ${entry.percentage}%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary));"></div>
              </div>
              <span style="font-weight: 600; color: var(--primary);">${entry.percentage}%</span>
            </div>
          </td>
        `;
        
        leaderboardBody.appendChild(row);
      });
    }
    
    // Clear leaderboard
    function clearLeaderboard() {
      if (confirm('‚ö†Ô∏è Are you sure you want to clear ALL leaderboard data? This cannot be undone!')) {
        localStorage.removeItem('cyber-shield-leaderboard');
        updateLeaderboard([]);
        alert('Leaderboard cleared!');
      }
    }
    
    function restartQuiz() {
      initializeQuiz();
    }

    function createConfetti() {
      const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
      const confettiCount = 50;
      
      for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.style.position = 'fixed';
        confetti.style.width = '10px';
        confetti.style.height = '10px';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.top = '-20px';
        confetti.style.opacity = '0.8';
        confetti.style.zIndex = '9999';
        confetti.style.pointerEvents = 'none';
        
        // Animation
        confetti.animate([
          { transform: `translateY(0) rotate(0deg)`, opacity: 1 },
          { transform: `translateY(${window.innerHeight + 100}px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
        ], {
          duration: Math.random() * 2000 + 1000,
          easing: 'cubic-bezier(0.215, 0.61, 0.355, 1)'
        });
        
        document.body.appendChild(confetti);
        
        // Remove after animation
        setTimeout(() => confetti.remove(), 3000);
      }
    }
    
    // ==== SCROLL ANIMATIONS ====
    function initScrollAnimations() {
      const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
      };
      
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.style.opacity = '1';
            entry.target.style.transform = 'translateY(0)';
          }
        });
      }, observerOptions);
      
      document.querySelectorAll('section').forEach(section => {
        section.style.opacity = '0';
        section.style.transform = 'translateY(20px)';
        section.style.transition = 'opacity 0.6s, transform 0.6s';
        observer.observe(section);
      });
    }
    
    // ==== INITIALIZATION ====
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize quiz
      initializeQuiz();
      
      // Load and display leaderboard
      updateLeaderboard();
      
      // Initialize scroll animations
      initScrollAnimations();
      
      // Add event listener for Enter key to restart quiz
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && document.getElementById('final-score').style.display === 'block') {
          restartQuiz();
        }
      });
    });
  </script>
